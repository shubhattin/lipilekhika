name: JS Package CI

on:
  - push

jobs:
  type_build_check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Typescript and Build Check
        run: |
          cd packages/js
          bun install
          bun run check
          bun run build
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: oven-sh/setup-bun@v2
      - name: Generate Test Data
        run: |
          bun install
          bun run gen:test-data
      - name: Test and Coverage
        run: |
          cd packages/js
          bun install
          bun run make-script-data
          # capture test output for GitHub summary while preserving exit code
          set -o pipefail
          bun test --coverage --concurrent 2>&1 | tee bun-test-output.txt
      - name: Append test report & coverage to summary
        if: always()
        run: |
          cd packages/js

          echo "### JS package tests" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "#### Test output" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          if [ -f bun-test-output.txt ]; then
            cat bun-test-output.txt >> "$GITHUB_STEP_SUMMARY"
          else
            echo "bun-test-output.txt not found (tests may have failed before running)." >> "$GITHUB_STEP_SUMMARY"
          fi
          echo '```' >> "$GITHUB_STEP_SUMMARY"

          if [ -d coverage ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "#### Coverage report" >> "$GITHUB_STEP_SUMMARY"
            echo "- **HTML report**: \`packages/js/coverage/index.html\`" >> "$GITHUB_STEP_SUMMARY"
          fi
