name: Release Mobile App

on:
  - push
  # paths:
  #   - "mobile-app/**"
  #   - "packages/dart/**"
  #   - "packages/rust/**"
  #   - ".github/workflows/release_mobile_app.yml"
  # - workflow_dispatch

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Setup Bun for script/test data generation
      - uses: oven-sh/setup-bun@v2
        name: Setup Bun

      - name: Generate Script Data
        run: |
          cd packages/js
          bun install
          bun run make-script-data

      # Setup Java (required for Android build)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      # Setup Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # Setup Rust
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Cache cargo registry + build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-android-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-android-

      # Install cargo-ndk
      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      # Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      # Install flutter_rust_bridge_codegen
      - name: Install flutter_rust_bridge_codegen
        run: cargo install flutter_rust_bridge_codegen

      # Enable script data in Rust package
      - name: Enable script data
        run: |
          cd packages/rust
          sed -i '/^src\/data\// s/^/#/' .gitignore

      # Generate Dart FFI bindings
      - name: Generate Dart bindings
        run: |
          cd packages/dart/lipilekhika
          flutter_rust_bridge_codegen generate

      # Build Android native libraries
      - name: Build Android native libraries
        run: |
          cd packages/dart/binding
          cargo ndk -t arm64-v8a -t armeabi-v7a -t x86_64 -t x86 \
            -o ../lipilekhika/android/src/main/jniLibs \
            build --release

      # Verify native libraries were built
      - name: Verify native libraries
        run: |
          ls -la packages/dart/lipilekhika/android/src/main/jniLibs/*/

      # Install Flutter dependencies for the app
      - name: Install Flutter dependencies
        run: |
          cd mobile-app
          flutter pub get

      # Build release APK
      - name: Build release APK
        run: |
          cd mobile-app
          flutter build apk --release --split-per-abi

      # Extract version from pubspec.yaml
      - name: Get version
        id: version
        run: |
          VERSION=$(grep "^version:" mobile-app/pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # Rename APKs to lipilekhika_version_arch.apk format
      - name: Rename split APKs
        run: |
          cd mobile-app/build/app/outputs/flutter-apk
          mv app-arm64-v8a-release.apk lipilekhika_${{ steps.version.outputs.version }}_arm64-v8a.apk
          mv app-armeabi-v7a-release.apk lipilekhika_${{ steps.version.outputs.version }}_armeabi-v7a.apk
          mv app-x86_64-release.apk lipilekhika_${{ steps.version.outputs.version }}_x86_64.apk

      # Upload APKs as artifacts
      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: release-apks
          path: |
            mobile-app/build/app/outputs/flutter-apk/lipilekhika_${{ steps.version.outputs.version }}_arm64-v8a.apk
            mobile-app/build/app/outputs/flutter-apk/lipilekhika_${{ steps.version.outputs.version }}_armeabi-v7a.apk
            mobile-app/build/app/outputs/flutter-apk/lipilekhika_${{ steps.version.outputs.version }}_x86_64.apk
          retention-days: 30

      # Also build a fat APK (all architectures in one)
      - name: Build universal APK
        run: |
          cd mobile-app
          flutter build apk --release

      - name: Rename universal APK
        run: |
          cd mobile-app/build/app/outputs/flutter-apk
          mv app-release.apk lipilekhika_${{ steps.version.outputs.version }}_universal.apk

      - name: Upload universal APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-universal
          path: mobile-app/build/app/outputs/flutter-apk/lipilekhika_${{ steps.version.outputs.version }}_universal.apk
          retention-days: 30

      # Build AAB for Google Play Console
      - name: Build release AAB
        run: |
          cd mobile-app
          flutter build appbundle --release

      - name: Rename AAB
        run: |
          cd mobile-app/build/app/outputs/bundle/release
          mv app-release.aab lipilekhika_${{ steps.version.outputs.version }}.aab

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: release-aab
          path: mobile-app/build/app/outputs/bundle/release/lipilekhika_${{ steps.version.outputs.version }}.aab
          retention-days: 30
